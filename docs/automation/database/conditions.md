---
title: 'Automation: Условия'
---

# Automation: Условия

<!-- TODO: поправить якорь -->
Для того, чтобы автоматизация сработала, необходимо, чтобы все условия были выполнены. Для случаев, когда требуется выполнение только одного из условий или когда нужны более сложные комбинации условий, можно использовать специальные [вложенные](#and-or-not) условия.

## Условие `property`

Это условие считается выполненным, если значение выбранного свойства соответствует заданным критериям.

Примеры описания условия:

```json
...
"conditions":
[
  {
    "type": "property",
    "endpoint": "zigbee/hallLight",
    "property": "status",
    "equals": "off"
  },
  {
    "type": "property",
    "endpoint": "zigbee/outdoorLight",
    "property": "status",
    "differs": "off"
  },
  {
    "type": "property",
    "endpoint": "zigbee/kitchenTemperature",
    "property": "temperature",
    "above": 20
  },
  {
    "type": "property",
    "endpoint": "zigbee/roomHumidity",
    "property": "humidity",
    "below": 40
  },
  {
    "type": "property",
    "endpoint": "zigbee/kitchenCurtain",
    "property": "position",
    "between": [50, 80]
  },
  {
    "type": "property",
    "endpoint": "zigbee/flowerSensor",
    "property": "moisture",
    "outside": [10, 90]
  }
]
...
```

!!! warning ""

    Поля `equals`, `differs`, `above`, `below`, `between` и `outside` не могут использоваться в одном условии одновременно.

    В качестве значения этих полей можно использовать [шаблоны](/automation/patterns/).

### `endpoint`

<!-- TODO: дать корректное описание -->

Конечная точка, свойство которой проверяется в условии, описанная в формате `service/device` или `service/device/N`, где `N` это номер конечной точки для многоканальных устройств.

По сути, значение этого поля явдяется частью топика [`fd`](/common/topics/#fd-from-device), отностящейся к конкретному устройству.

### `property`

Свойство конечной точки, которое проверяется у условии. Другими словами - название поля в сообщении с данными от устройства, значение которого проверяется у условии.

### `equals`

Условие считается выполненным, если значение свойства равно значению этого поля.

### `differs`

Условие считается выполненным, если значение свойства отлично от значения этого поля.

### `above`

Условие считается выполненным, если _числовое_ значение свойства превышает значение этого поля.

### `below`

Условие считается выполненным, если _числовое_ значение свойства ниже значения этого поля.

### `between`

Условие считается выполненным, если _числовое_ значение свойства находится в диапазоне, описанном в этом поле.

### `outside`

Условие считается выполненным, если _числовое_ значение свойства находится за пределами диапазона, описанного в этом поле.

## Условие `mqtt`

Это условие считается выполненным, если данные в определенном MQTT-топике соответствуют заданным критериям. Данные топиков, используемых в условиях, кешируются.

Примеры описания условия:

```json
...
"conditions":
[
  {
    "type": "mqtt",
    "topic": "some/sensor",
    "equals": false
  },
  {
    "type": "mqtt",
    "topic": "my/topic",
    "property": "number",
    "differs": 13
  },
  {
    "type": "mqtt",
    "topic": "another/sensor",
    "above": 200
  },
  {
    "type": "mqtt",
    "topic": "red/sensor",
    "property": "color",
    "below": 4.4
  },
  {
    "type": "mqtt",
    "topic": "numeric/value",
    "property": "value",
    "between": [1000, 2000]
  },
  {
    "type": "mqtt",
    "topic": "other/value",
    "outside": [100, 200]
  }
]
...
```

!!! warning ""

    Поля `equals`, `differs`, `above`, `below`, `between` и `outside` не могут использоваться в одном условии одновременно.

    В качестве значения этих полей можно использовать [шаблоны](/automation/patterns/).

### `topic`

MQTT-топик.

### `property`

Если это поле присутствует и заполнено, сервис будет ждать в сообщении JSON-объект и искать в нем соответсвующее свойство. В противном случае в качестве свойства будет использовано само сообщение.

В качестве имени свойства может быть использована составная строка, например, строка `buildings[3].address` получит значение поля `address` из элемента массива `buildings` c индексом `3`.

### `...`

Поля `equals`, `differs`, `above`, `below`, `between` и `outside` работают так же, как в условии [`property`](#property).

## Условие `state`

Это условие считается выполненным, если определенное [состояние](/automation/database/#_4) соответствует заданным критериям.

Примеры описания условия:

```json
...
"conditions":
[
  {
    "type": "state",
    "name": "booleanState",
    "equals": false
  },
  {
    "type": "state",
    "name": "someNumber",
    "differs": 42
  },
  {
    "type": "state",
    "name": "otherNumber",
    "above": 100
  },
  {
    "type": "state",
    "name": "customValue",
    "below": 2.5
  },
  {
    "type": "state",
    "name": "bigNumber",
    "between": [300000, 500000]
  },
  {
    "type": "state",
    "name": "smallNumber",
    "outside": [0.5, 0.8]
  }
]
...
```

!!! warning ""

    Поля `equals`, `differs`, `above`, `below`, `between` и `outside` не могут использоваться в одном условии одновременно.

    В качестве значения этих полей можно использовать [шаблоны](/automation/patterns/).

### `name`

Название состояния.

### `...`

Поля `equals`, `differs`, `above`, `below`, `between` и `outside` работают так же, как в условии [`property`](#property).

## Условие `date`

Это условие считается выполненным, если текущая дата соответствует заданным критериям. Даты необходимо указывать в формате `dd.MM` (день и месяц) или `dd` (только день, без указания месяца). В случае, если в параметрах условия указан только день (без месяца), условие будет выполняться каждый месяц.

Примеры описания условия:

```json
...
"conditions":
[
  {
    "type": "date",
    "equals": "08.03"
  },
  {
    "type": "date",
    "differs": "06"
  },
  {
    "type": "date",
    "above": "01.04"
  },
  {
    "type": "date",
    "below": "20"
  },
  {
    "type": "date",
    "between": ["01.06", "31.08"]
  },
  {
    "type": "date",
    "outside": ["31.12", "07.01"]
  }
]
...
```

!!! warning ""

    Поля `equals`, `differs`, `above`, `below`, `between` и `outside` не могут использоваться в одном условии одновременно.

    Формат даты `dd` применим ко всем полям, кроме `between` и `outside`.

### `equals`

Условие считается выполненным, если текущая дата равна значению этого поля.

### `differs`

Условие считается выполненным, если текущая дата отлична от значения этого поля.

### `above`

Условие считается выполненным, если текущая дата находится между значением этого поля и началом нового года.

### `below`

Условие считается выполненным, если текущая дата находится между началом текущего года и значением этого поля.

### `between`

Условие считается выполненным, если текущая дата находится в диапазоне, описанном в этом поле. При проверке условия учитывается наступление нового года.

### `outside`

Условие считается выполненным, если текущая дата находится за пределами диапазона, описанного в этом поле. При проверке условия учитывается наступление нового года.

## Условие `time`

Это условие считается выполненным, если текущее время суток соответствует заданным критериям. Время необходимо указывать в формате `hh:mm` (час, минута).  Вместо указания конкретного времени можно использовать ключевые слова `sunrise` и `sunset`, которые будут инерпретироваться как время рассвета и заката соответственно, а так же можно корректировать эти значения, добавив и или отняв необходимое число минут, например `sunset - 10` (за 10 минут до заката).

Примеры описания условия:

```json
...
"conditions":
[
  {
    "type": "time",
    "equals": "14:30"
  },
  {
    "type": "time",
    "differs": "04:20"
  },
  {
    "type": "time",
    "above": "sunset"
  },
  {
    "type": "time",
    "below": "18:20"
  },
  {
    "type": "time",
    "between": ["09:45", "17:15"]
  },
  {
    "type": "time",
    "outside": ["23:00", "07:00"]
  }
]
...
```

!!! warning ""

    Поля `equals`, `differs`, `above`, `below`, `between` и `outside` не могут использоваться в одном условии одновременно.

### `equals`

Условие считается выполненным, если текущее время суток равно значению этого поля.

### `differs`

Условие считается выполненным, если текущее время суток отлично от значения этого поля.

### `above`

Условие считается выполненным, если текущее время суток находится между значением этого поля и началом новых суток.

### `below`

Условие считается выполненным, если текущее время суток находится между началом текущих суток и значением этого поля.

### `between`

Условие считается выполненным, если текущее время суток находится в диапазоне, описанном в этом поле. При проверке условия учитывается наступление новых суток.

### `outside`

Условие считается выполненным, если текущее время суток находится за пределами диапазона, описанного в этом поле. При проверке условия учитывается наступление новых суток.

## Условие `week`

Это условие считается выполненным, если текущий день недели соответсвует одному из заданных.

Пример описания условия:

```json
...
"conditions":
[
  {
    "type": "week",
    "days": [1, 2, 3, 7]
  }
]
...
```

### `days`

Массив номеров дней недели, в которые условие будет выполнено, где `1` сответствует понедельнику, а `7` - воскресенью.

## Условие `pattern`

Это условие считается выполненным, если данные [шаблона](/automation/patterns/) соответствуют заданным критериям.

Примеры описания условия:

```json
...
"conditions":
[
  {
    "type": "pattern",
    "pattern": "{{ property | zigbee/motionSensor | occupancy }}",
    "equals": true
  },
  {
    "type": "pattern",
    "pattern": "{{ triggerName }}",
    "differs": "blah"
  },
  {
    "type": "pattern",
    "pattern": "{{ mqtt | someTopic | someValue }}",
    "above": 17.3
  },
  {
    "type": "pattern",
    "pattern": "{{ shellOutput }}",
    "below": 1400
  },
  {
    "type": "pattern",
    "pattern": "{{ state | myNumber }}",
    "between": [4815, 162342]
  },
  {
    "type": "pattern",
    "pattern": "{{ state | otherNumber }}",
    "outside": [356, 433]
  }
]
...
```

!!! warning ""

    Поля `equals`, `differs`, `above`, `below`, `between` и `outside` не могут использоваться в одном условии одновременно.

    В качестве значения этих полей можно использовать [шаблоны](/automation/patterns/).

### `pattern`

Проверяемый шаблон.

### `...`

Поля `equals`, `differs`, `above`, `below`, `between` и `outside` работают так же, как в условии [`property`](#property).

## Условия "AND", "OR" и "NOT"

Эти условия являются контейнерами для других условий. Такие контейнеры могут быть вложены друг в друга рекурсивно, сколько угодно раз.

Условие `AND` будет считаться выполенным, если _все_ вложенные условия будут выполены.

Условие `OR` будет считаться выполенным, если _хотя бы одно_ из вложенных условий будет выполено.

Условие `NOT` будет считаться выполенным, если _ни одно_ вложенное условие _не_ будет выполено.

Примеры описания условий:

```json
...
"conditions":
[
  {
    "type": "AND",
    "conditions":
    [
      {
        "type": "date",
        ...
      },
      {
        "type": "time",
        ...
      }
    ]
  },
  {
    "type": "OR",
    "conditions":
    [
      {
        "type": "property",
        ...
      },
      {
        "type": "AND",
        "conditions":
        [
          ...
        ]
      }
    ]
  },
  {
    "type": "NOT",
    "conditions":
    [
      {
        "type": "state",
        ...
      },
      {
        "type": "property",
        ...
      }
    ]
  }
]
...
```

### `conditions`

Массив вложенных условий.
